---
import Layout from "@/layouts/Layout.astro";
import { ResendVerificationForm } from "@/components/auth/ResendVerificationForm";

export const prerender = false;

const reason = Astro.url.searchParams.get("reason");
const reasonText = reason === "invalid_or_expired" ? "Link weryfikacyjny jest nieprawidłowy lub wygasł." : undefined;
---

<Layout title="Potwierdź e‑mail">
  <div class="container mx-auto px-4 py-16 max-w-md space-y-4">
    {reasonText && <div class="text-sm text-red-600">{reasonText}</div>}
    <div class="text-sm text-muted-foreground">
      Jeśli wcześniej potwierdziłeś e‑mail, możesz teraz
      <a href="/auth/login" class="underline underline-offset-4">zalogować się</a>.
    </div>
    <ResendVerificationForm client:only="react" />
  </div>
  <script>
    (function () {
      try {
        const hash = window.location.hash && window.location.hash.startsWith("#") ? window.location.hash.slice(1) : "";
        if (!hash) return;
        const hs = new URLSearchParams(hash);
        const hasAccess = hs.has("access_token") && hs.get("type") === "signup";
        const hasError = hs.has("error") || hs.has("error_code");

        // W każdej gałęzi usuń fragment z paska adresu
        const cleanUrl = window.location.pathname + window.location.search;
        window.history.replaceState({}, "", cleanUrl);

        if (hasAccess) {
          // Potwierdzono e‑mail po resend – nie tworzymy sesji z hash tokenów.
          // Kierujemy użytkownika do logowania z banerem potwierdzenia.
          window.location.replace("/auth/login?verified=1");
        } else if (hasError) {
          // Pozostajemy na stronie – użytkownik może wysłać link ponownie.
        }
      } catch (e) {
        // ignore
      }
    })();
  </script>
</Layout>
