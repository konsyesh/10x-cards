---
import Layout from "@/layouts/Layout.astro";
import { ResendVerificationForm } from "@/components/auth/ResendVerificationForm";
import { StatusAlert } from "@/components/StatusAlert";

export const prerender = false;

const reason = Astro.url.searchParams.get("reason");
const showExpiredAlert = reason === "invalid_or_expired";
---

<Layout title="Potwierdź e‑mail">
  <div class="container mx-auto px-4 py-16 max-w-md space-y-4">
    {
      showExpiredAlert && (
        <StatusAlert
          variant="destructive"
          title="Link weryfikacyjny jest nieprawidłowy lub wygasł."
          description="Poproś o nowy link weryfikujący e-mail."
          client:only="react"
        />
      )
    }
    <ResendVerificationForm client:only="react" />
  </div>
  <!-- eslint-disable prettier/prettier -->
  <script>
    (function () {
      try {
        const hash = window.location.hash && window.location.hash.startsWith("#") ? window.location.hash.slice(1) : "";
        if (!hash) return;
        const hs = new URLSearchParams(hash);
        const hasAccess = hs.has("access_token") && hs.get("type") === "signup";
        const hasError = hs.has("error") || hs.has("error_code");

        // W każdej gałęzi usuń fragment z paska adresu
        const cleanUrl = window.location.pathname + window.location.search;
        window.history.replaceState({}, "", cleanUrl);

        if (hasAccess) {
          // Potwierdzono e‑mail po resend – nie tworzymy sesji z hash tokenów.
          // Kierujemy użytkownika do logowania z banerem potwierdzenia.
          window.location.replace("/auth/login?verified=1");
        } else if (hasError) {
          // Pozostajemy na stronie – użytkownik może wysłać link ponownie.
        }
      } catch {
        // ignore
      }
    })();
  </script>
</Layout>
